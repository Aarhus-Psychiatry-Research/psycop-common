FROM kubeflownotebookswg/codeserver-python@sha256:ed6a094c5d6a1df6fa3d7a775ed3509d8e98fa1507977bc6bc93d990ba636b61
USER root

# Install system requirements
RUN apt-get update
RUN apt install build-essential -y
RUN apt install unixodbc -y

# Install Python packages
ENV UV_SYSTEM_PYTHON=1
RUN pip install uv

COPY test-requirements.txt .
RUN --mount=type=cache,target=/root/.cache/uv uv pip install -r test-requirements.txt --no-compile

COPY dev-requirements.txt .
RUN --mount=type=cache,target=/root/.cache/uv uv pip install -r dev-requirements.txt --no-compile

COPY gpu-requirements.txt .
RUN --mount=type=cache,target=/root/.cache/uv uv pip install -r gpu-requirements.txt --no-compile

COPY requirements.txt .
RUN --mount=type=cache,target=/root/.cache/uv uv pip install -r requirements.txt --no-compile

# Ensure pyright is installed from npm
RUN pyright --help

ENV UV_SYSTEM_PYTHON=1
COPY . /app