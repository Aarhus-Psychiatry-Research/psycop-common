Combine medication, hba1c and diagnoses to find first date where the patient has t2d.


## Filter function
```{r}
df_first_t2d_combined <- df_first_date_of_t2d_medication_prescription %>% 
  bind_rows(df_first_t2d_blood_sample) %>% 
  bind_rows(df_t2d_diagnoses_combined) %>% 
  group_by(dw_ek_borger) %>% 
  filter(datotid_start == min(datotid_start)) %>% 
  select(dw_ek_borger, datotid_start) %>% 
  distinct(dw_ek_borger, datotid_start)
```


# Wash-in
We don't know whether a patient has had t2d before our follow-up time starts. To avoid false-positives (i.e. where both doctor and patient already knew the patient was diabetic), exclude all incident cases within the first year of follow-up starting. I call this "wash-in".

```{r}
df_exclude_for_wash_in <- df_first_date_of_t2d_medication_prescription %>% 
  filter(datotid_start < event_start_date)
```

# Remove patients with incidence before first psych-contact
## LPR3, both in and outpatient
```{r}
df_lpr3_raw <- con %>% 
  tbl(sql("SELECT * FROM [fct].FOR_LPR3kontakter_psyk_somatik_inkl_2021")) %>% 
  collect %>% 
  format_sql_import()


df_lpr3_preproc <- df_lpr3_raw %>% 
  filter(substr(shakkode_lpr3kontaktophold, 1, 4) == 6600) %>% # Only psychiatry in RM
  select(dw_ek_borger, datotid_lpr3kontaktstart)
```

## LPR2
### LPR2 inpatient
```{r}
df_lpr2_inp_raw <- con %>% 
  tbl(sql("SELECT * FROM [fct].FOR_indlaeggelser_psyk_somatik_LPR2_inkl_2021")) %>% 
  collect %>% 
  format_sql_import()

df_lpr2_inp_preproc <- df_lpr2_inp_raw %>% 
  filter(substr(shakkode_kontaktansvarlig, 1, 4) == 6600) %>% # Only psychiatry in RM
  rename(datotid_start = datotid_indlaeggelse) %>% 
  select(dw_ek_borger, datotid_start)
```

### LPR2 outpatient
```{r}
df_lpr2_outp_raw <- con %>% 
  tbl(sql("SELECT * FROM [fct].FOR_besoeg_psyk_somatik_LPR2_inkl_2021")) %>% 
  collect %>% 
  format_sql_import()

df_lpr2_outp_preproc <- df_lpr2_outp_raw %>% 
  filter(substr(shakafskode, 1, 4) == 6600) %>% # Only psychiatry in RM
  select(dw_ek_borger, datotid_start)
```

### LPR2 combined
```{r}
df_lp2_first_p_combined <- df_lpr2_inp_preproc %>% 
  bind_rows(df_lpr2_outp_preproc) %>% 
  group_by(dw_ek_borger) %>% 
  filter(datotid_start == min(datotid_start))
```

