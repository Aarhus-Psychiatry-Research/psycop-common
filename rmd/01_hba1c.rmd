Find the first date where a patient gets a diabetic hba1c-blood-sample.

```{r}
library("pacman")

p_load(tidyverse, here, future)
source(here("psycop_r_utils", "import_from_sql.r"))

```

```{r}
con <- DBI::dbConnect(
        odbc::odbc(),
        Driver = "SQL Server",
        Server = "BI-DPA-PROD",
        database = "USR_PS_Forsk",
        Trusted_Connection = "TRUE"
)
```

# Get first date of hba1c above threshold
## From only that administered
```{r}
df_first_diabetes_blood_sample <- con %>% 
  tbl(sql("SELECT * FROM [fct].FOR_LABKA_NPU27300_HbA1c_inkl_2021")) %>% 
  select(dw_ek_borger, datotid_proevemodtagelse, numerisksvar, analysenavn) %>% 
  filter(numerisksvar >= 48) %>% 
  group_by(dw_ek_borger) %>% 
  filter(datotid_proevemodtagelse == min(datotid_proevemodtagelse)) %>% 
  collect %>% 
  group_by(dw_ek_borger) %>% 
  filter(row_number() == 1) %>% 
  ungroup() %>% 
  format_sql_import() %>% 
  rename(datotid_start = datotid_proevemodtagelse)
```

# Wash-in
We don't know whether a patient has had diabetes before our follow-up time starts. To avoid false-positives (i.e. where both doctor and patient already knew the patient was diabetic), exclude all incident cases within the first year of follow-up starting. I call this "wash-in".